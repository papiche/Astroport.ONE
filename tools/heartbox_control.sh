#!/bin/bash
################################################################################
# Author: Fred (support@qo-op.com)
# Version: 1.0
# License: AGPL-3.0 (https://choosealicense.com/licenses/agpl-3.0/)
################################################################################
# ‚ô•Ô∏èBOX CONTROL - Interface CLI compl√®te pour la gestion des ‚ô•Ô∏èbox UPlanet
# Int√®gre : monitoring syst√®me, WireGuard, Swarm, VISA, services
################################################################################

MY_PATH="`dirname \"$0\"`"
MY_PATH="`( cd \"$MY_PATH\" && pwd )`"
. "${MY_PATH}/my.sh"

# Configuration des couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Configuration globale
HEARTBOX_DIR="$HOME/.zen/heartbox"
mkdir -p "$HEARTBOX_DIR"

#######################################################################
# Fonctions utilitaires d'affichage
#######################################################################

print_header() {
    local title="$1"
    echo -e "${BLUE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    printf "‚ïë%*s‚ïë\n" $((78)) ""
    printf "‚ïë%*s%s%*s‚ïë\n" $(((78-${#title})/2)) "" "$title" $(((78-${#title})/2)) ""
    printf "‚ïë%*s‚ïë\n" $((78)) ""
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
}

print_section() {
    local title="$1"
    echo -e "${CYAN}"
    echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
    printf "‚îÇ %-76s ‚îÇ\n" "$title"
    echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
    echo -e "${NC}"
}

print_status() {
    local service="$1"
    local status="$2"
    local details="$3"
    
    if [[ "$status" == "ACTIVE" ]]; then
        printf "  ‚úÖ %-20s ${GREEN}%-10s${NC} %s\n" "$service" "$status" "$details"
    elif [[ "$status" == "INACTIVE" ]]; then
        printf "  ‚ùå %-20s ${RED}%-10s${NC} %s\n" "$service" "$status" "$details"
    else
        printf "  ‚ö†Ô∏è  %-20s ${YELLOW}%-10s${NC} %s\n" "$service" "$status" "$details"
    fi
}

#######################################################################
# Analyse mat√©rielle et syst√®me
#######################################################################

get_system_info() {
    local cpu_model=$(grep "model name" /proc/cpuinfo | head -1 | cut -d':' -f2 | xargs 2>/dev/null || echo "Non d√©tect√©")
    local cpu_cores=$(grep "processor" /proc/cpuinfo | wc -l 2>/dev/null || echo "0")
    local cpu_freq=$(grep "cpu MHz" /proc/cpuinfo | head -1 | cut -d':' -f2 | xargs 2>/dev/null || echo "Non d√©tect√©")
    local cpu_load=$(uptime | awk -F'load average:' '{ print $2 }' | xargs)
    
    local mem_total=$(grep "MemTotal" /proc/meminfo | awk '{print $2}' 2>/dev/null || echo "0")
    local mem_available=$(grep "MemAvailable" /proc/meminfo | awk '{print $2}' 2>/dev/null || echo "0")
    local mem_used=$((mem_total - mem_available))
    local mem_total_gb=$((mem_total / 1024 / 1024))
    local mem_used_gb=$((mem_used / 1024 / 1024))
    local mem_usage_percent=$((mem_used * 100 / mem_total))
    
    local disk_info=$(df -h / | tail -1)
    local disk_total=$(echo "$disk_info" | awk '{print $2}')
    local disk_used=$(echo "$disk_info" | awk '{print $3}')
    local disk_available=$(echo "$disk_info" | awk '{print $4}')
    local disk_usage_percent=$(echo "$disk_info" | awk '{print $5}')
    
    echo -e "${WHITE}Processeur:${NC} $cpu_model"
    echo -e "${WHITE}C≈ìurs:${NC} $cpu_cores threads @ ${cpu_freq} MHz"
    echo -e "${WHITE}Charge CPU:${NC} $cpu_load"
    echo ""
    echo -e "${WHITE}M√©moire:${NC} ${mem_used_gb}GB / ${mem_total_gb}GB (${mem_usage_percent}%)"
    echo -e "${WHITE}Disque:${NC} $disk_used / $disk_total ($disk_usage_percent utilis√©)"
    echo -e "${WHITE}Libre:${NC} $disk_available"
    
    # GPU detection
    if command -v nvidia-smi >/dev/null 2>&1; then
        local gpu_info=$(nvidia-smi --query-gpu=name,memory.total,memory.used,utilization.gpu --format=csv,noheader,nounits 2>/dev/null | head -1)
        if [[ -n "$gpu_info" ]]; then
            echo -e "${WHITE}GPU:${NC} $gpu_info"
        fi
    fi
}

#######################################################################
# Calcul des capacit√©s d'abonnement
#######################################################################

calculate_subscription_capacity() {
    local disk_info=$(df -h / | tail -1)
    local disk_available_str=$(echo "$disk_info" | awk '{print $4}')
    
    # Conversion en GB
    local available_gb=$(echo "$disk_available_str" | sed 's/G//' | sed 's/T/*1024/' | bc 2>/dev/null || echo "0")
    
    if [[ $(echo "$available_gb > 0" | bc 2>/dev/null) -eq 1 ]]; then
        local zencard_parts=$(echo "($available_gb - 8*128) / 128" | bc 2>/dev/null || echo "0")
        local nostr_parts=$(echo "($available_gb - 8*10) / 10" | bc 2>/dev/null || echo "0")
        
        [[ $(echo "$zencard_parts < 0" | bc 2>/dev/null) -eq 1 ]] && zencard_parts=0
        [[ $(echo "$nostr_parts < 0" | bc 2>/dev/null) -eq 1 ]] && nostr_parts=0
        
        echo -e "${WHITE}Capacit√©s d'abonnement:${NC}"
        echo "  üé´ ZenCards (128 GB/slot): $zencard_parts slots"
        echo "  üìª NOSTR Cards (10 GB/slot): $nostr_parts slots"
        echo "  üë®‚Äç‚úàÔ∏è  R√©serv√© capitaine: 8 slots (1024 GB)"
    else
        echo -e "${RED}‚ùå Impossible de calculer les capacit√©s${NC}"
    fi
}

#######################################################################
# √âtat des services
#######################################################################

check_services_status() {
    print_section "üîß √âTAT DES SERVICES"
    
    # IPFS
    if pgrep ipfs >/dev/null; then
        local ipfs_size=$(du -sh ~/.ipfs 2>/dev/null | cut -f1 || echo "N/A")
        local ipfs_peers=$(ipfs swarm peers 2>/dev/null | wc -l || echo "0")
        print_status "IPFS" "ACTIVE" "($ipfs_size, $ipfs_peers peers)"
    else
        print_status "IPFS" "INACTIVE" ""
    fi
    
    # Astroport
    if pgrep -f "12345" >/dev/null; then
        print_status "Astroport" "ACTIVE" "(API: http://localhost:12345)"
    else
        print_status "Astroport" "INACTIVE" ""
    fi
    
    # NextCloud
    if command -v docker >/dev/null 2>&1 && docker ps --filter "name=nextcloud" --format "{{.Names}}" 2>/dev/null | grep -q nextcloud; then
        local nc_status=$(docker ps --filter "name=nextcloud" --format "{{.Status}}" 2>/dev/null | head -1)
        print_status "NextCloud" "ACTIVE" "($nc_status)"
    else
        print_status "NextCloud" "INACTIVE" "(Docker ou conteneurs non d√©marr√©s)"
    fi
    
    # WireGuard
    if sudo wg show wg0 >/dev/null 2>&1; then
        local wg_peers=$(sudo wg show wg0 | grep -c "peer:" || echo "0")
        print_status "WireGuard" "ACTIVE" "($wg_peers clients connect√©s)"
    else
        print_status "WireGuard" "INACTIVE" ""
    fi
    
    # G1Billet
    if pgrep -f "G1BILLETS" >/dev/null; then
        print_status "G1Billet" "ACTIVE" ""
    else
        print_status "G1Billet" "INACTIVE" ""
    fi
}

#######################################################################
# Analyse du Swarm
#######################################################################

analyze_swarm() {
    print_section "üåê ANALYSE DE L'ESSAIM UPLANET"
    
    local swarm_dir="$HOME/.zen/tmp/swarm"
    if [[ -d "$swarm_dir" ]]; then
        local node_count=$(find "$swarm_dir" -maxdepth 1 -type d -name "12D*" | wc -l)
        local active_nodes=0
        
        echo -e "${WHITE}Nodes d√©couverts:${NC} $node_count"
        
        for node_dir in "$swarm_dir"/12D*; do
            if [[ -d "$node_dir" && -f "$node_dir/12345.json" ]]; then
                local node_id=$(basename "$node_dir")
                local captain=$(jq -r '.captain' "$node_dir/12345.json" 2>/dev/null)
                local paf=$(jq -r '.PAF' "$node_dir/12345.json" 2>/dev/null)
                local hostname=$(jq -r '.hostname' "$node_dir/12345.json" 2>/dev/null)
                
                if [[ "$captain" != "null" && "$captain" != "" ]]; then
                    echo "  üì° ${node_id:0:8}... ‚Üí $captain ($hostname) - PAF: $paf ·∫ê"
                    ((active_nodes++))
                fi
            fi
        done
        
        echo -e "${WHITE}Nodes actifs:${NC} $active_nodes/$node_count"
    else
        echo "‚ùå Aucun r√©pertoire swarm trouv√©"
    fi
    
    # Abonnements locaux
    local sub_file="$HOME/.zen/tmp/$IPFSNODEID/swarm_subscriptions.json"
    if [[ -f "$sub_file" ]]; then
        local sub_count=$(jq '.subscriptions | length' "$sub_file" 2>/dev/null || echo "0")
        echo -e "${WHITE}Abonnements sortants:${NC} $sub_count"
    fi
    
    # Abonnements re√ßus
    local recv_file="$HOME/.zen/tmp/$IPFSNODEID/swarm_subscriptions_received.json"
    if [[ -f "$recv_file" ]]; then
        local recv_count=$(jq '.received_subscriptions | length' "$recv_file" 2>/dev/null || echo "0")
        echo -e "${WHITE}Abonnements re√ßus:${NC} $recv_count"
    fi
}

#######################################################################
# Menu principal
#######################################################################

show_main_menu() {
    clear
    print_header "‚ô•Ô∏èBOX CONTROL - Pilotage UPlanet"
    
    echo -e "${WHITE}Node ID:${NC} $IPFSNODEID"
    echo -e "${WHITE}Capitaine:${NC} $(cat ~/.zen/game/players/.current/.player 2>/dev/null || echo 'Non connect√©')"
    echo -e "${WHITE}Type:${NC} $(if [[ -f ~/.zen/game/secret.dunikey ]]; then echo "Y Level (Node autonome)"; else echo "Standard"; fi)"
    echo ""
    
    get_system_info
    echo ""
    calculate_subscription_capacity
    echo ""
    check_services_status
    echo ""
    analyze_swarm
    echo ""
    
    echo -e "${YELLOW}ACTIONS DISPONIBLES:${NC}"
    echo "  1. üìä Monitoring d√©taill√©"
    echo "  2. üåê Gestion WireGuard"
    echo "  3. üîó Gestion Swarm UPlanet"
    echo "  4. üé´ Impression VISA/ZenCard"
    echo "  5. üõ†Ô∏è  Gestion des services"
    echo "  6. üì± NextCloud Docker"
    echo "  7. üìã Logs et diagnostics"
    echo "  8. ‚öôÔ∏è  Configuration"
    echo "  0. ‚ùå Quitter"
    echo ""
}

#######################################################################
# Monitoring d√©taill√©
#######################################################################

show_detailed_monitoring() {
    clear
    print_header "üìä MONITORING D√âTAILL√â"
    
    # Processus en cours
    print_section "üîÑ PROCESSUS ACTIFS"
    echo "Processus UPlanet:"
    pgrep -af "ipfs\|12345\|astroport\|zen" | head -10
    echo ""
    
    # Utilisation r√©seau
    print_section "üåê R√âSEAU")
    echo "Connexions IPFS:"
    netstat -tan | grep ":5001\|:4001\|:8080" | head -5
    echo ""
    echo "Connexions Astroport:"
    netstat -tan | grep ":12345\|:54321" | head -5
    echo ""
    
    # Utilisation disque d√©taill√©e
    print_section "üíæ UTILISATION DISQUE")
    echo "R√©pertoires principaux:"
    du -sh ~/.zen ~/.ipfs /nextcloud-data 2>/dev/null | sort -hr
    echo ""
    
    # Logs r√©cents
    print_section "üìù LOGS R√âCENTS")
    echo "Derni√®res activit√©s:"
    tail -5 ~/.zen/tmp/12345.log 2>/dev/null || echo "Aucun log 12345"
    echo ""
    tail -5 ~/.zen/tmp/ipfs.swarm.peers 2>/dev/null || echo "Aucun log IPFS"
    
    echo ""
    echo "Appuyez sur ENTR√âE pour revenir au menu principal..."
    read
}

#######################################################################
# Gestion WireGuard
#######################################################################

manage_wireguard() {
    clear
    print_header "üåê GESTION WIREGUARD")
    
    echo "1. üöÄ Initialiser serveur WireGuard"
    echo "2. üë• Ajouter un client"
    echo "3. üìã Afficher configuration"
    echo "4. üîÑ Red√©marrer service"
    echo "5. üõ†Ô∏è  Client setup (ce node)"
    echo "0. ‚¨ÖÔ∏è  Retour"
    echo ""
    read -p "Choix: " wg_choice
    
    case $wg_choice in
        1) 
            echo "üöÄ Initialisation du serveur WireGuard..."
            sudo "${MY_PATH}/wireguard_control.sh"
            ;;
        2)
            read -p "Nom du client: " client_name
            echo "Collez la cl√© SSH publique du client:"
            read -p "> " client_pubkey
            echo "$client_name|$client_pubkey" | sudo "${MY_PATH}/wireguard_control.sh"
            ;;
        3)
            echo "üìã Configuration WireGuard:"
            sudo wg show wg0 2>/dev/null || echo "‚ùå WireGuard non configur√©"
            ;;
        4)
            echo "üîÑ Red√©marrage WireGuard..."
            sudo systemctl restart wg-quick@wg0
            ;;
        5)
            "${MY_PATH}/wg-client-setup.sh"
            ;;
    esac
    
    [[ $wg_choice != "0" ]] && { echo ""; read -p "Appuyez sur ENTR√âE..."; }
}

#######################################################################
# Gestion Swarm
#######################################################################

manage_swarm() {
    clear
    print_header "üîó GESTION SWARM UPLANET")
    
    echo "1. üîç D√©couvrir l'essaim"
    echo "2. üìä Statut des abonnements"
    echo "3. üîî Notifications re√ßues"
    echo "4. üí∞ Paiements Swarm"
    echo "5. ‚ùì Aide Swarm"
    echo "0. ‚¨ÖÔ∏è  Retour"
    echo ""
    read -p "Choix: " swarm_choice
    
    case $swarm_choice in
        1) "${MY_PATH}/../RUNTIME/SWARM.discover.sh" ;;
        2) 
            echo "üìä Statut des abonnements Swarm:"
            if [[ -f "$HOME/.zen/tmp/$IPFSNODEID/swarm_subscriptions.json" ]]; then
                jq '.' "$HOME/.zen/tmp/$IPFSNODEID/swarm_subscriptions.json"
            else
                echo "‚ùå Aucun abonnement trouv√©"
            fi
            ;;
        3) "${MY_PATH}/SWARM.notifications.sh" ;;
        4) "${MY_PATH}/../ZEN.SWARM.payments.sh" ;;
        5) "${MY_PATH}/SWARM.help.sh" ;;
    esac
    
    [[ $swarm_choice != "0" ]] && { echo ""; read -p "Appuyez sur ENTR√âE..."; }
}

#######################################################################
# Impression VISA/ZenCard
#######################################################################

manage_visa() {
    clear
    print_header "üé´ IMPRESSION VISA/ZENCARD")
    
    local current_player=$(cat ~/.zen/game/players/.current/.player 2>/dev/null)
    
    echo "1. üñ®Ô∏è  Imprimer VISA du capitaine actuel"
    echo "2. üÜï Cr√©er nouvelle ZenCard"
    echo "3. üé® Imprimer ZenCard personnalis√©e"
    echo "0. ‚¨ÖÔ∏è  Retour"
    echo ""
    
    if [[ -n "$current_player" ]]; then
        echo -e "${WHITE}Capitaine actuel:${NC} $current_player"
    else
        echo -e "${RED}‚ùå Aucun capitaine connect√©${NC}"
    fi
    echo ""
    
    read -p "Choix: " visa_choice
    
    case $visa_choice in
        1)
            if [[ -n "$current_player" ]]; then
                echo "üñ®Ô∏è  Impression VISA pour $current_player..."
                "${MY_PATH}/VISA.print.sh" "$current_player"
            else
                echo "‚ùå Aucun capitaine connect√©"
            fi
            ;;
        2)
            read -p "Email: " email
            read -p "Secret 1: " salt
            read -p "Secret 2: " pepper
            read -p "PIN (4 chiffres): " pin
            echo "üÜï Cr√©ation ZenCard..."
            "${MY_PATH}/VISA.print.sh" "$email" "$salt" "$pepper" "$pin"
            ;;
        3)
            echo "üé® Fonctionnalit√© √† venir..."
            ;;
    esac
    
    [[ $visa_choice != "0" ]] && { echo ""; read -p "Appuyez sur ENTR√âE..."; }
}

#######################################################################
# Gestion des services
#######################################################################

manage_services() {
    clear
    print_header "üõ†Ô∏è  GESTION DES SERVICES")
    
    echo "1. üîÑ Red√©marrer IPFS"
    echo "2. üîÑ Red√©marrer Astroport"
    echo "3. üîÑ Red√©marrer G1Billet"
    echo "4. üîÑ Red√©marrer tous les services"
    echo "5. üõë Arr√™ter tous les services"
    echo "6. üöÄ D√©marrer tous les services"
    echo "0. ‚¨ÖÔ∏è  Retour"
    echo ""
    read -p "Choix: " service_choice
    
    case $service_choice in
        1) 
            echo "üîÑ Red√©marrage IPFS..."
            sudo systemctl restart ipfs
            ;;
        2)
            echo "üîÑ Red√©marrage Astroport..."
            sudo systemctl restart astroport 2>/dev/null || {
                killall nc 12345.sh 2>/dev/null
                "${MY_PATH}/../12345.sh" > ~/.zen/tmp/12345.log &
            }
            ;;
        3)
            echo "üîÑ Red√©marrage G1Billet..."
            sudo systemctl restart g1billet 2>/dev/null || echo "Service G1Billet non trouv√©"
            ;;
        4)
            echo "üîÑ Red√©marrage de tous les services..."
            sudo systemctl restart ipfs astroport g1billet 2>/dev/null
            ;;
        5)
            echo "üõë Arr√™t de tous les services..."
            sudo systemctl stop ipfs astroport g1billet 2>/dev/null
            ;;
        6)
            echo "üöÄ D√©marrage de tous les services..."
            sudo systemctl start ipfs astroport g1billet 2>/dev/null
            ;;
    esac
    
    [[ $service_choice != "0" ]] && { echo ""; read -p "Appuyez sur ENTR√âE..."; }
}

#######################################################################
# NextCloud Docker
#######################################################################

manage_nextcloud() {
    clear
    print_header "üì± NEXTCLOUD DOCKER")
    
    local compose_file="$HOME/.zen/Astroport.ONE/_DOCKER/nextcloud/docker-compose.yml"
    
    echo "1. üöÄ D√©marrer NextCloud"
    echo "2. üõë Arr√™ter NextCloud"
    echo "3. üîÑ Red√©marrer NextCloud"
    echo "4. üìä √âtat des conteneurs"
    echo "5. üìã Logs NextCloud"
    echo "0. ‚¨ÖÔ∏è  Retour"
    echo ""
    
    if [[ -f "$compose_file" ]]; then
        echo -e "${WHITE}Configuration:${NC} $compose_file"
    else
        echo -e "${RED}‚ùå Configuration NextCloud non trouv√©e${NC}"
    fi
    echo ""
    
    read -p "Choix: " nc_choice
    
    case $nc_choice in
        1)
            if [[ -f "$compose_file" ]]; then
                echo "üöÄ D√©marrage NextCloud..."
                cd "$(dirname "$compose_file")" && docker-compose up -d
            else
                echo "‚ùå Fichier docker-compose.yml non trouv√©"
            fi
            ;;
        2)
            echo "üõë Arr√™t NextCloud..."
            cd "$(dirname "$compose_file")" && docker-compose down 2>/dev/null
            ;;
        3)
            echo "üîÑ Red√©marrage NextCloud..."
            cd "$(dirname "$compose_file")" && docker-compose restart 2>/dev/null
            ;;
        4)
            echo "üìä √âtat des conteneurs NextCloud:"
            docker ps --filter "name=nextcloud"
            ;;
        5)
            echo "üìã Logs NextCloud:"
            docker logs nextcloud-aio-mastercontainer 2>/dev/null | tail -20
            ;;
    esac
    
    [[ $nc_choice != "0" ]] && { echo ""; read -p "Appuyez sur ENTR√âE..."; }
}

#######################################################################
# Logs et diagnostics
#######################################################################

show_logs() {
    clear
    print_header "üìã LOGS ET DIAGNOSTICS")
    
    echo "1. üìä Observer logs en temps r√©el"
    echo "2. üìù Logs Astroport"
    echo "3. üåê Logs IPFS"
    echo "4. üîó Logs Swarm"
    echo "5. üíæ Archive 20h12"
    echo "6. üîç Diagnostic complet"
    echo "0. ‚¨ÖÔ∏è  Retour"
    echo ""
    read -p "Choix: " log_choice
    
    case $log_choice in
        1) "${MY_PATH}/log_observation.sh" --menu ;;
        2) tail -f ~/.zen/tmp/12345.log 2>/dev/null || echo "‚ùå Aucun log Astroport" ;;
        3) tail -f ~/.zen/tmp/ipfs.swarm.peers 2>/dev/null || echo "‚ùå Aucun log IPFS" ;;
        4) tail -f ~/.zen/tmp/DRAGON.log 2>/dev/null || echo "‚ùå Aucun log Swarm" ;;
        5) 
            if [[ -f /tmp/20h12.log ]]; then
                less /tmp/20h12.log
            else
                echo "‚ùå Archive 20h12 non trouv√©e"
            fi
            ;;
        6)
            echo "üîç Diagnostic complet en cours..."
            "${MY_PATH}/../20h12.process.sh" 2>&1 | tail -50
            ;;
    esac
    
    [[ $log_choice != "0" ]] && { echo ""; read -p "Appuyez sur ENTR√âE..."; }
}

#######################################################################
# Configuration
#######################################################################

manage_config() {
    clear
    print_header "‚öôÔ∏è  CONFIGURATION")
    
    echo "1. üîß Configuration IPFS"
    echo "2. üåê Configuration r√©seau"
    echo "3. üí∞ Configuration √©conomie ZEN"
    echo "4. üîë Gestion cl√©s SSH"
    echo "5. üìß Configuration email"
    echo "0. ‚¨ÖÔ∏è  Retour"
    echo ""
    read -p "Choix: " config_choice
    
    case $config_choice in
        1)
            echo "üîß Configuration IPFS:"
            if [[ -f ~/.ipfs/config ]]; then
                echo "StorageMax: $(jq -r '.Datastore.StorageMax' ~/.ipfs/config)"
                echo "GC Watermark: $(jq -r '.Datastore.StorageGCWatermark' ~/.ipfs/config)%"
                echo "Swarm HighWater: $(jq -r '.Swarm.ConnMgr.HighWater' ~/.ipfs/config)"
            else
                echo "‚ùå Configuration IPFS non trouv√©e"
            fi
            ;;
        2)
            echo "üåê Configuration r√©seau:"
            echo "Node ID: $IPFSNODEID"
            echo "Ports IPFS: $(netstat -tan | grep LISTEN | grep -E ':4001|:5001|:8080')"
            ;;
        3)
            echo "üí∞ Configuration √©conomie ZEN:"
            if [[ -f ~/.zen/tmp/economics.json ]]; then
                cat ~/.zen/tmp/economics.json
            else
                echo "‚ùå Configuration √©conomique non trouv√©e"
            fi
            ;;
        4)
            echo "üîë Cl√©s SSH:"
            if [[ -f ~/.ssh/id_ed25519.pub ]]; then
                echo "Cl√© publique ED25519:"
                cat ~/.ssh/id_ed25519.pub
            else
                echo "‚ùå Aucune cl√© SSH ED25519 trouv√©e"
            fi
            ;;
        5)
            echo "üìß Configuration email:"
            echo "Capitaine email: $(cat ~/.zen/game/players/.current/.player 2>/dev/null || echo 'Non configur√©')"
            ;;
    esac
    
    [[ $config_choice != "0" ]] && { echo ""; read -p "Appuyez sur ENTR√âE..."; }
}

#######################################################################
# Boucle principale
#######################################################################

main_loop() {
    while true; do
        show_main_menu
        read -p "Votre choix: " choice
        
        case $choice in
            1) show_detailed_monitoring ;;
            2) manage_wireguard ;;
            3) manage_swarm ;;
            4) manage_visa ;;
            5) manage_services ;;
            6) manage_nextcloud ;;
            7) show_logs ;;
            8) manage_config ;;
            0) 
                echo -e "${GREEN}üëã Au revoir !${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}‚ùå Choix invalide${NC}"
                sleep 1
                ;;
        esac
    done
}

#######################################################################
# Point d'entr√©e
#######################################################################

# V√©rification des pr√©requis
if [[ ! -f "${MY_PATH}/my.sh" ]]; then
    echo "‚ùå Fichier my.sh non trouv√©. Ex√©cutez depuis le r√©pertoire Astroport.ONE/tools/"
    exit 1
fi

# D√©marrage de l'interface
clear
echo -e "${CYAN}‚ô•Ô∏èBOX CONTROL${NC} - Chargement..."
sleep 1

main_loop 