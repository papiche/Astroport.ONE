# 🛒 uMARKET System

## Overview

The uMARKET system is a specialized marketplace application for UPlanet that processes Nostr messages containing the `#market` tag and creates a dedicated web interface for displaying local market advertisements.

## Architecture

### Components

1. **NOSTR.UMAP.refresh.sh** - Modified to detect `#market` tags and generate JSON advertisements
2. **generate_uMARKET.sh** - Creates the marketplace web interface
3. **test_uMARKET.sh** - Test script for the system

### Data Flow

```
Nostr Message with #market tag
           ↓
NOSTR.UMAP.refresh.sh processes message
           ↓
Creates JSON advertisement in ads/ directory
           ↓
Downloads associated images to Images/ directory
           ↓
generate_uMARKET.sh compiles all ads into market.json
           ↓
Generates web interface (_index.html)
           ↓
IPFS CID for the marketplace
```

## File Structure

```
UMAP_APP/uDRIVE/
├── ads/                    # JSON advertisement files
│   ├── message_id_1.json
│   ├── message_id_2.json
│   └── ...
├── Images/                 # Product images
│   ├── UMAP_xxx_lat_lon_image1.jpg
│   └── ...
├── public/                 # Generated by generate_uMARKET.sh
│   ├── market.json         # Compiled advertisements
│   └── _index.html         # Web interface
└── index.html              # Redirect to IPFS CID
```

## JSON Advertisement Format

Each advertisement is stored as a JSON file with the following structure:

```json
{
    "id": "message_id",
    "content": "Original message content with #market tag",
    "author_pubkey": "nostr_public_key",
    "author_nprofile": "nostr:npub1...",
    "created_at": 1703000000,
    "location": {
        "lat": 48.85,
        "lon": 2.35
    },
    "local_images": ["image1.jpg", "image2.jpg"],
    "umap_id": "UMAP_xxx_lat_lon"
}
```

## Usage

### For Merchants

1. **Post a Nostr message** with the `#market` tag
2. **Include product images** as URLs in the message
3. **The system automatically**:
   - Downloads images to the local UMAP
   - Creates a JSON advertisement
   - Includes it in the marketplace interface

Example message:
```
🍎 Fresh organic apples from my garden! 
Perfect for pies and cider. 
Price: 1 DU/kg
#market #organic #local
https://example.com/apples.jpg
```

### For Consumers

1. **Visit the marketplace** at the UMAP's IPFS URL
2. **Browse products** by category, price, or location
3. **Contact sellers** via their Nostr profile
4. **View product images** and details

## Features

### Automatic Processing
- ✅ Detects `#market` tags in Nostr messages
- ✅ Downloads and stores product images
- ✅ Creates structured JSON advertisements
- ✅ Generates responsive web interface

### Web Interface
- ✅ Modern, mobile-friendly design
- ✅ Product cards with images
- ✅ Search and filter functionality
- ✅ Author information and contact details
- ✅ Location-based organization

### Data Management
- ✅ Automatic cleanup of old advertisements (6 months)
- ✅ Notification to authors when ads expire
- ✅ IPFS-based storage and distribution
- ✅ JSON-based data structure for easy processing

## Testing

Run the test script to see the system in action:

```bash
cd Astroport.ONE/tools/
./test_uMARKET.sh
```

This will:
1. Create sample advertisements
2. Generate the marketplace interface
3. Display the compiled market.json
4. Show the IPFS CID for the interface

## Integration

The uMARKET system integrates seamlessly with the existing UPlanet infrastructure:

- **UMAPs** automatically detect and process market messages
- **Sectors** aggregate market activity from multiple UMAPs
- **Regions** provide broader market overview
- **IPFS** ensures decentralized storage and access

## Future Enhancements

Potential improvements for the uMARKET system:

- [ ] Price extraction and sorting
- [ ] Category-based filtering
- [ ] Distance-based search
- [ ] Seller ratings and reviews
- [ ] Direct messaging between buyers and sellers
- [ ] Payment integration
- [ ] Inventory management
- [ ] Market analytics and trends

## Technical Details

### Dependencies
- `jq` - JSON processing
- `ipfs` - Decentralized storage
- `nostpy-cli` - Nostr communication
- `wget` - Image downloading

### Security
- All advertisements are signed by their authors
- Images are stored locally with UMAP-specific naming
- JSON structure prevents injection attacks
- IPFS provides content-addressed storage

### Performance
- Lazy loading of images
- Efficient JSON compilation
- Minimal IPFS operations
- Responsive web interface 