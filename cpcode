#!/bin/bash
show_help() {
    echo "Usage : $0 [--help] <extension1> [<extension2> ...] <dossier_source>"
    echo "Options :"
    echo "  --help    Affiche cette aide."
    exit 0
}
if [ "$1" == "--help" ]; then show_help; fi
if [ "$#" -lt 2 ]; then
    echo "Erreur : Arguments manquants."
    show_help
    exit 1
fi

EXTENSIONS=("${@:1:$#-1}")
SOURCE_DIR="${@: -1}"

if [ ! -d "$SOURCE_DIR" ]; then
    echo "Erreur : Le dossier source '$SOURCE_DIR' n'existe pas."
    exit 1
fi

MOATS=$(date -u +"%Y%m%d%H%M%S%4N")
TEMP_FILE="/tmp/$MOATS.txt"
RESULT=""

for EXT in "${EXTENSIONS[@]}"; do
    while IFS= read -r FILE; do
        if file "$FILE" | grep -q "text"; then
            RELATIVE_PATH=$(realpath --relative-to="$SOURCE_DIR" "$FILE")
            FILENAME=$(basename "$FILE" | sed "s/\.$EXT$//")
            echo "Ajout de : $FILE"
            RESULT+="Chemin : $RELATIVE_PATH\n"
            RESULT+="Titre : $FILENAME\n\n"
            RESULT+="$(cat "$FILE")\n\n"
        fi
    done < <(find "$SOURCE_DIR" -type f -name "*.$EXT" | grep -v '/\.')
done

echo -e "$RESULT" > "$TEMP_FILE"

if [ ! -s "$TEMP_FILE" ]; then
    echo "Erreur : Aucun fichier trouvé avec les extensions spécifiées dans '$SOURCE_DIR'."
    rm -f "$TEMP_FILE"
    exit 1
fi

# Tenter le presse-papiers sans vérification bloquante
COPIED=false
if [ -n "$DISPLAY" ] && command -v xclip &>/dev/null; then
    if cat "$TEMP_FILE" | xclip -selection clipboard 2>/dev/null; then
        COPIED=true
        echo "Contenu copié dans le presse-papiers."
    fi
elif command -v pbcopy &>/dev/null; then
    if cat "$TEMP_FILE" | pbcopy 2>/dev/null; then
        COPIED=true
        echo "Contenu copié dans le presse-papiers."
    fi
fi


echo "Résultat écrit dans : $TEMP_FILE"

