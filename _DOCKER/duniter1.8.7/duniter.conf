# Fail2ban filter for Duniter Docker container
# Detects DDOS attacks and failed requests to Duniter services

[Definition]
# Fail regex patterns for Duniter requests
# Based on actual Duniter logs showing DDOS attacks

# DDOS attack detection (from your logs)
failregex = ^.*ddos: denied: entry: <HOST>#.*{ count: \d+, expiry: \d+ }$
            ^.*"GET /.* HTTP/.*" [4-5][0-9][0-9] .*$
            ^.*"POST /.* HTTP/.*" [4-5][0-9][0-9] .*$
            ^.*"PUT /.* HTTP/.*" [4-5][0-9][0-9] .*$
            ^.*"DELETE /.* HTTP/.*" [4-5][0-9][0-9] .*$
            ^.*"HEAD /.* HTTP/.*" [4-5][0-9][0-9] .*$
            ^.*"OPTIONS /.* HTTP/.*" [4-5][0-9][0-9] .*$
            ^.*"PATCH /.* HTTP/.*" [4-5][0-9][0-9] .*$
            ^.*"TRACE /.* HTTP/.*" [4-5][0-9][0-9] .*$
            ^.*"CONNECT /.* HTTP/.*" [4-5][0-9][0-9] .*$

# Ignore regex patterns (successful requests, health checks, and legitimate peer connections)
ignoreregex = ^.*"GET /health HTTP/.*" 200 .*$
              ^.*"GET /ping HTTP/.*" 200 .*$
              ^.*"GET /status HTTP/.*" 200 .*$
              ^.*"GET /metrics HTTP/.*" 200 .*$
              ^.*"GET /favicon.ico HTTP/.*" 200 .*$
              ^.*"GET /robots.txt HTTP/.*" 200 .*$
              ^.*"GET /.* HTTP/.*" 200 .*$
              ^.*"POST /.* HTTP/.*" 200 .*$
              ^.*"PUT /.* HTTP/.*" 200 .*$
              ^.*"DELETE /.* HTTP/.*" 200 .*$
              ^.*"HEAD /.* HTTP/.*" 200 .*$
              ^.*"OPTIONS /.* HTTP/.*" 200 .*$
              ^.*"PATCH /.* HTTP/.*" 200 .*$
              ^.*"TRACE /.* HTTP/.*" 200 .*$
              ^.*"CONNECT /.* HTTP/.*" 200 .*$
              # Ignore legitimate WS2P peer connections
              ^.*WS2P.*new incoming connection from <HOST>.*$
              ^.*WS2P.*established incoming connection from.*<HOST>.*$
              ^.*WS2P.*connected to peer.*using.*$
              ^.*WS2P.*init: bundle of peers.*$
              # Ignore blockchain operations
              ^.*Block resolution.*$
              ^.*Blocks were not applied.*$
              ^.*Fork resolution.*$
              ^.*SIDE Block.*added to the blockchain.*$ 